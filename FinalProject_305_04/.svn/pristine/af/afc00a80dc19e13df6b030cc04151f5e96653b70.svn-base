<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.student.graduation.dao.GraduationDAO">

	<resultMap type="MGradReqVO" id="mGradReqMap" autoMapping="true">
		<id property="mgradReqId" column="MGRAD_REQ_ID" />
		<association property="semesterVO" javaType="SemesterVO" autoMapping="true" />
		<collection property="majorVO" ofType="MajorVO" autoMapping="true">
			<association property="collList" javaType="CollVO" autoMapping="true" />
		</collection>
<!-- 		<association property="majorVO" javaType="MajorVO" autoMapping="true" /> -->
		<collection property="gradReqList" ofType="GradReqVO" autoMapping="true" />
	</resultMap>
	
	<select id="selectMGradReqList" resultMap="mGradReqMap">
		WITH A AS
			(SELECT DISTINCT 
						MGRAD_REQ_ID
						, MAJOR_ID
						, SEME_ID
						, MAJOR_NM
						, COLL_ID
						, COLL_NM
						, SEME_YEAR
					FROM V_GRAD_REQ
			)
			SELECT ROWNUM RNUM, A.*
			FROM A
	</select>
	
	<select id="selectMGradReq" parameterType="String" resultMap="mGradReqMap">
		SELECT 
			GRAD_REQ_ID
			, MGRAD_REQ_ID
			, REQ_ITEM
			, REQ_STAND
			, MAJOR_ID
			, SEME_ID
			, MAJOR_NM
			, COLL_ID
			, COLL_NM
			, SEME_YEAR
			, SEME
		FROM V_GRAD_REQ
    	WHERE MGRAD_REQ_ID = #{mGradReqId}
	</select>
	
	<select id="selectSemester" resultType="SemesterVO">
		SELECT SEME_ID, SEME_YEAR
		FROM SEMESTER
		WHERE SEME = 1
		ORDER BY SEME_YEAR DESC
	</select>
	
	<insert id="insertMGradReq" parameterType="MGradReqVO">
		<selectKey order="BEFORE" resultType="String" keyProperty="mgradReqId">
			SELECT 
				'FT' || TO_CHAR(SUBSTR(MAX(MGRAD_REQ_ID), 3)+1)
			FROM MGRAD_REQ
		</selectKey>
		INSERT INTO MGRAD_REQ (
			MGRAD_REQ_ID
			, MAJOR_ID
			, SEME_ID
		) VALUES (
			#{mgradReqId}
			, #{majorId,jdbcType=VARCHAR}
			, #{semeId,jdbcType=VARCHAR}
		)
	</insert>
	
	
	<resultMap type="StudentVO" id="stdMap" autoMapping="true">
		<id property="stdId" column="STD_ID" />
		<association property="collVO" javaType="CollVO" autoMapping="true"/>
		<association property="majorVO" javaType="MajorVO" autoMapping="true"/>
		<collection property="gradFulList" ofType="GradFulVO" autoMapping="true">
			<id property="gradFulId" column="GRAD_FUL_ID" />
			<association property="gradReqVO" javaType="GradReqVO" autoMapping="true" />
		</collection>
	</resultMap>
	
	<select id="selectGradFulList" parameterType="String" resultMap="stdMap">
		SELECT
		    A.STD_ID
		    , A.MAJOR_ID
		    , B.MAJOR_NM
		    , C.COLL_ID
		    , C.COLL_NM
		    , D.GRAD_FUL_ID
		    , D.GRAD_REQ_ID
		    , D.FUL_CHECK
		    , D.MGRAD_REQ_ID
		    , E.SEME_ID
		    , E.REQ_ITEM
		    , E.REQ_STAND
		    , E.SEME_YEAR
		FROM STUDENT A INNER JOIN MAJOR B ON A.MAJOR_ID = B.MAJOR_ID
		    INNER JOIN COLL C ON B.COLL_ID = C.COLL_ID
		    RIGHT OUTER JOIN GRAD_FUL D ON (A.STD_ID = D.STD_ID)
		    INNER JOIN V_GRAD_REQ E ON (D.GRAD_REQ_ID = E.GRAD_REQ_ID AND D.MGRAD_REQ_ID = E.MGRAD_REQ_ID)
		WHERE A.STD_ID = #{stdId}
	</select>
	
	
	<resultMap type="CurrLectVO" id="currLectMap" autoMapping="true">
		<id property="curlectId" column="CURLECT_ID"/>
		<association property="lectureVO" javaType="LectureVO" autoMapping="true"></association>
	</resultMap>
	<select id="selectCurrLectList" parameterType="String" resultMap="currLectMap">
		SELECT A.CURLECT_ID
		    , A.STD_ID
		    , A.LECT_ID
		    , A.FIN_SCORE
		    , B.LECT_NM
		    , B.SEME_ID
		    , B.SUBJECT_NM
		    , B.ESTA_SUB
		    , B.CREDIT
		    , B.MAJOR_NM
		    , B.COLL_NM
		    , C.COMM_DESC
		FROM CURR_LECT A INNER JOIN V_LECTUREINFO B ON A.LECT_ID = B.LECT_ID
		INNER JOIN COMM C ON B.ESTA_SUB = C.COMM_ID
		WHERE STD_ID = #{stdId}
	</select>
	
	<!-- 현재까지 이수한 총 학점 -->
	<select id="selectTotalCredit" parameterType="String" resultType="int">
		SELECT 
			NVL(SUM(CREDIT), 0) AS "TOTAL_CREDIT"
		FROM CURR_LECT A INNER JOIN V_LECTUREINFO B ON A.LECT_ID = B.LECT_ID
		INNER JOIN COMM C ON B.ESTA_SUB = C.COMM_ID
		WHERE STD_ID = #{stdId}
	</select>
	
	<!-- 현재까지 이수한 전공필수학점 -->
	<select id="selectMajorReqCredit" parameterType="String" resultType="int">
		SELECT 
			NVL(SUM(CREDIT), 0) AS "MJ01"
		FROM CURR_LECT A INNER JOIN V_LECTUREINFO B ON A.LECT_ID = B.LECT_ID
		INNER JOIN COMM C ON B.ESTA_SUB = C.COMM_ID
		WHERE ESTA_SUB = 'MJ01'
		AND STD_ID = #{stdId}
	</select>
	
	<!-- 현재까지 이수한 전공선택학점 -->
	<select id="selectMajorOptCredit" parameterType="String" resultType="int">
		SELECT 
			NVL(SUM(CREDIT), 0) AS "MJ02"
		FROM CURR_LECT A INNER JOIN V_LECTUREINFO B ON A.LECT_ID = B.LECT_ID
		INNER JOIN COMM C ON B.ESTA_SUB = C.COMM_ID
		WHERE ESTA_SUB = 'MJ02'
		AND STD_ID = #{stdId}
	</select>
	
	<!-- 현재까지 이수한 교양필수학점 -->
	<select id="selectGEReqCredit" parameterType="String" resultType="int">
		SELECT 
			NVL(SUM(CREDIT), 0) AS "GE01"
		FROM CURR_LECT A INNER JOIN V_LECTUREINFO B ON A.LECT_ID = B.LECT_ID
		INNER JOIN COMM C ON B.ESTA_SUB = C.COMM_ID
		WHERE ESTA_SUB = 'GE01'
		AND STD_ID = #{stdId}
	</select>
	
	<!-- 현재까지 이수한 교양선택학점 -->
	<select id="selectGEOptCredit" parameterType="String" resultType="int">
		SELECT 
			NVL(SUM(CREDIT), 0) AS "GE02"
		FROM CURR_LECT A INNER JOIN V_LECTUREINFO B ON A.LECT_ID = B.LECT_ID
		INNER JOIN COMM C ON B.ESTA_SUB = C.COMM_ID
		WHERE ESTA_SUB = 'GE02'
		AND STD_ID = #{stdId}
	</select>
	
	
	
	

</mapper>